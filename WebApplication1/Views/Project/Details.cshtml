@model prjMusicBetter.Models.TProject

@{
    ViewData["Title"] = "Details";
}

<!-- Intro section -->
<input type="hidden" id="styleId" value="@Html.DisplayFor(model => model.FStyleId)" />
<input type="hidden" id="memberId" value="@Html.DisplayFor(model => model.FMemberId)" />
<input type="hidden" id="budget" value="@Html.DisplayFor(model => model.FBudget)" />
<input type="hidden" id="pID" value="@Html.DisplayFor(model => model.FProjectId)" />

<section class="intro-section spad">
    <div class="container">
        <div class="row d-flex justify-content-center">
            <div class="col-lg-3">
                <div class="playlist-item">
                    <img src="~/img/project/@Html.DisplayFor(model => model.FThumbnailPath)" alt="">
                </div>
            </div>
            <div class="col-lg-6">
                <div>
                    <h2>@Html.DisplayFor(model => model.FName)</h2>
                </div>
                <div class="mb-2"></div>
                <div class="">
                    <h5 id="styleName"></h5>
                    <div class="mb-2"></div>
                    <h5 id="budgetDisplay"></h5>
                </div>
                
            </div>
            <div class="col-lg-3 text-right">
                <a href="~/project/applyconfirm" class="btn btn-danger btn-lg mr-2">應徵</a>
                <button href="#" class="btn btn-warning btn-lg mr-2">追蹤製作</button>
            </div>
            <div class="col-lg-10">
                <p>
                    @Html.DisplayFor(model => model.FDescription)
                </p>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-lg-12 col-xl-11">
                <div class="card text-black" style="border-radius: 25px;">
                    <div class="card-body p-md-5">
	                    
	                    <div class="container">
		                    <div class="row">
                                <div class="col-lg-6">
                                    <h3>製作專案Demo</h3>
                                    <div class="mb-2"></div>
                                </div>
                                <div class="col-lg-12">             
                                    <div class="song-details-box">
                                        <!-- song -->
                                        <div class="song-item">
                                            <div class="row">
                                                <div class="col-xl-5 col-lg-12 col-md-5">
                                                    <div class="song-info-box">
                                                        @*<img src="~/img/songs/1.jpg" alt="">*@
                                                        <div class="song-info text-right">
                                                            <h4>@Html.DisplayFor(model => model.FDemoFilePath)</h4>
                                                            <p>One Night in Ibiza</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-xl-7 col-lg-12 col-md-7">
                                                    <div class="single_player_container" >

                                                        <audio id="myAudio" controls style="width: 100%;">
                                                            <source src="~/ProjectDemo/@Html.DisplayFor(model => model.FDemoFilePath)" type="audio/mp3">
                                                            Your browser does not support the audio element.
                                                        </audio>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
		                    </div>
		
	                    </div>
	                    <div class="container">
		                    <div class="row">
			                    <div class="col-lg-3">
				                    <h3>製作專長需求</h3>
			                    </div>
			                    <div class="col-lg-12">
				                    <p>
					                    @Html.DisplayFor(model => model.FDescription2)
				                    </p>
			                    </div>
		                    </div>
	                    </div>
	                    <div class="container">
		                    <div class="row" id="memberInfo">
		                    </div>
	                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button id="btnEdit" class="btn btn-secondary m-1" data-bs-toggle="modal" data-bs-target="#addModal">修改專案</button>
</section>

<!-- Modal -->
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">修改專案 <span></span></h5>
                @*      <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>*@
                @*<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">取消</button>*@
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" name="id" id="fProjectId" value="@Html.DisplayFor(model => model.FProjectId)">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-group">
                                <div style="display: flex; justify-content: center; align-items: center; height: 230px;">
                                    <img id="imgPreview" style="height: 200px;" alt="">
                                </div>
                                <div style="display: flex; justify-content: center; align-items: center;">
                                    <input type="file" id="imgFile" name="formFilePhoto" @*class="btn btn-secondary"*@ @*style="display: none;"*@>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="fName">製作名稱</label>
                                <input type="text" class="form-control" id="fName" name="fName">
                            </div>
                            <div class="form-group">
                                <label for="FBudget">預算</label>
                                <input type="text" class="form-control" id="fBudget" name="fBudget">
                            </div>
                            <div class="form-group">
                                <label for="FBudget">風格</label>
                                <select id="selectStyle" class="form-select" name="fStyleId"></select>
                            </div>
                            <div class="form-group">
                                <label for="FBudget">製作期限</label>
                                <input type="datetime-local" class="form-control" id="fEnddate" name="fEnddate">
                            </div>
                            
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label for="FBudget">製作描述</label>
                                <textarea class="form-control" id="fDescription" name="fDescription" style="height: 200px;"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="FBudget">專長需求</label>
                                <textarea class="form-control" id="fDescription2" name="fDescription2" style="height: 200px;"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="FBudget">上傳Demo</label>
                                <input type="file" id="demoFile" name="formFileDemo" @*style="display: none;"*@>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-file-x-fill"></i> 關閉</button>
                <button type="button" class="btn btn-primary" id="buttonSend"><i class="bi bi-send-check-fill"></i> 送出 </button>
            </div>
        </div>
    </div>
</div>
<!-- Intro section end -->


@*<div>
    <h4>TProject</h4>
    <hr 
            @Html.DisplayFor(model => model.FDescription)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FThumbnailPath)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FThumbnailPath)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FDescription2)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FDescription2)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FStyleId)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FStyleId)
        </dd>/>
    <dl class="row">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FName)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FName)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FBudget)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FBudget)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FStartdate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FStartdate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FEnddate)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FEnddate)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FDescription)
        </dt>
        <dd class = "col-sm-10">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FMember)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FMember.FMemberId)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FProjectStatus)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FProjectStatus.FProjectStatusId)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FSite)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FSite.FSiteId)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.FSiteNavigation)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.FSiteNavigation.FStyleId)
        </dd>
    </dl>
</div>
<div>
    <a asp-action="Edit" asp-route-id="@Model?.FProjectId">Edit</a> |
    <a asp-action="Index">Back to List</a>
</div>*@

@section Scripts{
	<script>
		const styleId = $('#styleId').val();
		const memberId = $('#memberId').val();
        const projectID = $('#pID').val();
        
        //取得風格資訊
		$.getJSON(`/apiTStyle/QueryById/${styleId}`, function (datas) {
			console.log(datas);
			$('#styleName').html(`製作風格 : ${datas[0].fName}`);
		})
        //取得會員資訊
		$.getJSON(`/apiTProjects/QueryMemberById/${memberId}`, function (datas) {
			console.log(datas);
			$('#memberInfo').html(`
				<div class="col-lg-6" >
					<h5>製作發案人 : ${datas.fUsername}</h5>
				</div>
				<div class="col-lg-6" >
					<h5 class="text-right">聯絡電話 : ${datas.fPhone}<br>Email : ${datas.fEmail}</h5>
				</div>
				`);
		})
        //預算去小數點
        const budget = $('#budget').val();
        var roundedBudget = Math.floor(budget);
        $('#budgetDisplay').html(`預算 : ${roundedBudget}`);

        //Style選擇器
        const selStyle = document.querySelector('#selectStyle');
        async function loadStyle() {
            const response = await fetch('@Url.Content("~/apiTStyle/List")');
            const data = await response.json();

            const defaultOption = '<option>請選擇風格</option>';
            const styleOptions = data.map(s => `<option id="styOpt${s.fStyleId}" value="${s.fStyleId}">${s.fName}</option>`);
            styleOptions.unshift(defaultOption);
            selStyle.innerHTML = styleOptions.join("");

            document.getElementById(`styOpt${styleId}`).selected = true;
        }
        
        //按下修改按鈕
        $('#btnEdit').click(function () {
            loadStyle();
            //幫彈出視窗填入資料
            $.getJSON(`/apiTProjects/QueryById/${projectID}`, function (datas) {
                console.log(datas);
                $('#fName').val(datas.fName);
                $('#fBudget').val(datas.fBudget);
                $('#fEnddate').val(datas.fEnddate);
                $('#fDescription').text(datas.fDescription);
                $('#fDescription2').text(datas.fDescription2);
                $('#imgPreview').attr('src', `/img/project/${datas.fThumbnailPath}`);
            })
        })
        //圖片預覽
        var arrayBuffer;

        $("#imgFile").bind("change", function () {
            var file = this.files[0];
            var allowType = "image.*";
            if (file.type.match(allowType)) {
                //預覽
                var reader = new FileReader();
                reader.onload = function () {
                    arrayBuffer = this.result;
                    var blob = new Blob([arrayBuffer], {
                        type: "image/jpeg"
                    });
                    var urlCreator = window.URL || window.webkitURL;
                    var imageURL = urlCreator.createObjectURL(blob);
                    $("#imgPreview").attr("src", imageURL);
                };
                reader.readAsArrayBuffer(this.files[0]);
            }
            else {
                alert("不支援的檔案類型");
            }
        });

        //修改資料
        $('#buttonSend').click(function () {
            const formData = new FormData(document.querySelector('#editForm'));
            fetch('@Url.Content("~/apiTProjects/Edit")' + '/' + projectID, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    alert("修改成功");
                    location.href = '@Url.Content("~/Project/Details/")' + projectID;
                }
                else{
                    alert("連線失敗");
                }
            })
        })
	</script>
}